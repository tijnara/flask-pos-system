{% extends "base.html" %}

{% block content %}
<h2>New Transaction</h2>

<div class="pos-grid-container">

    {# Left Panel: Product/Action Buttons #}
    <div class="pos-add-to-sale">
        <h3>Add to Sale</h3>
        <div class="product-button-grid">
            {# --- Prioritized Buttons --- #}
            {% for p in prioritized_products %}
             <form method="POST" action="{{ url_for('pos_interface') }}">
                <input type="hidden" name="action" value="add_item">
                <input type="hidden" name="product_name" value="{{ p.ProductName }}">
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="product-btn">
                    {{ p.ProductName }}<br><span class="price">(₱{{ "%.2f"|format(p.Price) }})</span>
                </button>
            </form>
            {% endfor %}

            {# Custom Sale Button - Always display near top #}
            <button type="button" id="customSaleBtn" class="product-btn custom-sale-btn">
                 Custom Sale<br><span class="price">(₱0.00)</span>
            </button>

            {# --- Other Product Buttons --- #}
            {% for p in other_products %}
             <form method="POST" action="{{ url_for('pos_interface') }}">
                <input type="hidden" name="action" value="add_item">
                <input type="hidden" name="product_name" value="{{ p.ProductName }}">
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="product-btn">
                    {{ p.ProductName }}<br><span class="price">(₱{{ "%.2f"|format(p.Price) }})</span>
                </button>
            </form>
            {% endfor %}
        </div>
    </div>

    {# Right Panel: Current Sale Details and Actions #}
    <div class="pos-current-sale-panel">
        <h3>Current Sale</h3>
        <div class="current-sale-items-list">
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: center;">Qty</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                        <th>Act</th>
                    </tr>
                </thead>
                <tbody>
                    {% if current_sale_items %}
                        {% for item in current_sale_items %}
                        <tr>
                            <td>{{ item.name }}</td>
                            <td class="quantity-controls">
                                <form method="POST" action="{{ url_for('pos_interface') }}" style="display: inline;">
                                    <input type="hidden" name="action" value="decrease_qty">
                                    <input type="hidden" name="item_name" value="{{ item.name }}">
                                    <input type="hidden" name="item_price" value="{{ item.price }}">
                                    <button type="submit" class="btn-qty" title="Decrease Quantity">-</button>
                                </form>
                                <span class="item-quantity">{{ item.quantity }}</span>
                                <form method="POST" action="{{ url_for('pos_interface') }}" style="display: inline;">
                                    <input type="hidden" name="action" value="increase_qty">
                                    <input type="hidden" name="item_name" value="{{ item.name }}">
                                    <input type="hidden" name="item_price" value="{{ item.price }}">
                                    <button type="submit" class="btn-qty" title="Increase Quantity">+</button>
                                </form>
                            </td>
                            <td>₱{{ "%.2f"|format(item.price) }}</td>
                            <td>₱{{ "%.2f"|format(item.subtotal) }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('pos_interface') }}" style="display: inline;">
                                    <input type="hidden" name="action" value="remove_item">
                                    <input type="hidden" name="item_name" value="{{ item.name }}">
                                    <input type="hidden" name="item_price" value="{{ item.price }}">
                                    <button type="submit" class="btn-danger btn-remove-item" title="Remove Item">X</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: #777;">No items added yet.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {# Customer Selection Area #}
        <div class="customer-area">
             <form method="POST" action="{{ url_for('pos_interface') }}" style="display: inline-block; margin-right: 10px;">
                 <input type="hidden" name="action" value="set_customer">
                 <input list="customer_suggestions" id="customer_name_input" name="customer_name_select" class="form-control" placeholder="Type Customer or N/A" value="{{ current_customer if current_customer != 'N/A' else '' }}" style="display: inline-block; width: auto;">
                 <datalist id="customer_suggestions">
                     <option value="N/A">N/A (Walk-in)</option>
                     {% for c in customers %} <option value="{{ c.CustomerName }}"> {% endfor %}
                 </datalist>
                 <button type="submit" class="btn btn-info btn-pos-action">Set</button>
             </form>
             <span class="latest-customer">Selected Customer: {{ current_customer }}</span>
        </div>

        {# Finalize and Total Area #}
        <div class="finalize-area">
            <form method="POST" action="{{ url_for('pos_interface') }}" style="display: inline-block;">
                <input type="hidden" name="action" value="finalize_sale">
                <button type="submit" class="btn btn-success btn-finalize" {% if not current_sale_items %}disabled{% endif %}>Finalize Sale</button>
            </form>
            <span class="total-display">Total: ₱{{ "%.2f"|format(current_total) }}</span>
        </div>

        {# Bottom Action Buttons #}
        <div class="bottom-actions">
             <form method="POST" action="{{ url_for('pos_interface') }}" style="display: inline-block;">
                 <input type="hidden" name="action" value="clear_sale">
                 <button type="submit" class="btn btn-warning btn-pos-action">Clear Sale</button>
             </form>
             <a href="{{ url_for('list_sales') }}" class="btn btn-info btn-pos-action">View History</a>
        </div>
    </div>

</div>

{# --- Custom Sale Modal --- #}
<div id="customSaleModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Custom Sale Item</h2>
        <form id="customSaleForm" method="POST" action="{{ url_for('pos_interface') }}">
            <input type="hidden" name="action" value="add_custom_item">

            <div class="form-group">
                <label for="custom_product_name">Product:</label>
                {# --- MODIFIED: Changed input to select --- #}
                <select id="custom_product_name" name="custom_product_name" class="form-control" required>
                    <option value="" disabled selected>-- Select Product --</option>
                    {# Loop through all available products (prioritized + others) #}
                    {% for p in prioritized_products %}
                        <option value="{{ p.ProductName }}">{{ p.ProductName }}</option>
                    {% endfor %}
                     {% for p in other_products %}
                        <option value="{{ p.ProductName }}">{{ p.ProductName }}</option>
                    {% endfor %}
                     {# Optionally add a generic 'Custom Item' if needed #}
                     {# <option value="Custom Item">Custom Item (Specify Price)</option> #}
                </select>
                 {# --- END MODIFICATION --- #}
            </div>

            <div class="form-group">
                <label for="custom_price">Custom Price:</label>
                <input type="number" id="custom_price" name="custom_price" step="0.01" min="0" required placeholder="Enter price for selected item">
                 {# Consider disabling this unless a specific 'Custom Item' option is chosen #}
            </div>

            <div class="form-group">
                <label for="custom_quantity">Quantity:</label>
                <input type="number" id="custom_quantity" name="custom_quantity" value="1" min="1" required>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-success">Add to Sale</button>
                <button type="button" class="btn btn-secondary cancel-button">Cancel</button>
            </div>
        </form>
    </div>
</div>
{# --- End Custom Sale Modal --- #}

{% endblock %}
